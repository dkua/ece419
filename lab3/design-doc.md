# ECE419 Lab 3 - Preliminary Design Document
#### David Kua; 998484536; david.kua@mail.utoronto.ca


### Overview
This peer­to­peer (P2P) implementation of Mazewar supports dynamic joining for up to four players on the same LAN.
It employs the use of Vector Clocks (VC) and the Ricart-Agrawala (R-A) algorithm to enforce synchronization and mutual exclusion.
Its main components include a room serv{ice,er} and a multicasting system for client communication.


### Components

#### Room Service
The room service (RS) is required for the creation of a game of Mazewar.
It is used to coordinate the joining and quitting of players (clients) into a game.
This is accomplished by having the NS maintain a central store of all connected and disconnected players.
The RS maintains two concurrent hashmap data structures for connected and disconnected players.
The keys and values are the clientId and clientData respectively.

When a player wants to join a new game they must enter their game name, a port number, and the address of the RS.
The client sends a join request to the RS containing their game name and port number.
The RS will check among its store of connected players to see if anyone is using the requested port number.
If yes, the RS will notify the client of a failed join and the player will need to try again with a different port.
Otherwise the RS will create a new entry in its connected player store.
The clientId is an unique hash generated by the RS formed from the hashing of the string "<game name>:<port>:<local timestamp>".
The clientData (as a tuple, another hashmap, etc) will contain the game name, port, and any other relevant information.
The RS will finally broadcast the clientId and clientData to all clients.
This notifies the joining client that they have a successful join and notifies all other clients that a new player has connected.

When a player wants to quit a game their client sends the RS a quit request along with their clientId.
The RS will move their entry from the connected store to the disconnected store and send back an ACK.

It is assumed that all connections with the RS are under perfect network connections (no dropped packets) and that the RS is always running for the entirety of a Mazewar game.


#### Client(s)
Similarly to the Lab 2 implementation of Mazewar, clients consist of a Handler, Listener, and Dispatcher.
The Handler is responsible for maintaining the event queue, applying events, and communicating with the RS.
The Listener is responsible for receiving Event Packets (EPs) from other clients on the chosen port and enqueuing them onto the event queue.
Before enqueuing an EP the Listener is responsible for sorting the packets by their VCs.
The Dispatcher is responsible for sending all outgoing EPs to other clients such as key presses.
It is assumed that all peer connections between clients run on the typical game network (packets may be dropped, reordered, etc).

##### PlayerClient
The PlayerClient is an implementation of a Client with all its parts (Handler, Listener, and Dispatcher) plus the GUI for players to be able to view the game.
This is the client of which players' will be using to play the game.

##### RobotClient
The RobotClient is an implementation of a Client that is played by a computer/program/autonomously.
It may or may not have some sort of artificial intelligence implemented to make it "smarter". 


#### Communication Protocol
The communication protocol here is based off of the R-A algorithm for distributed mutual exclusion discussed in class.
When a client wants to act on a non-concurrent event it must broadcast a proposal vector clock for that event to its peer clients (PC).
The RC will instantiate a counter of replies of size N-1.
PCs will check if the proposed VC is usable and reply with a NACK if it is not or an ACK if it is and update it's own VC accordingly.
When the RC receives a ACK or NACK it decrements it's counter until it reaches 0.
If the proposed VC has been disacknowledged then the RC must attempt again with another updated proposal VC.
If the proposed VC has been acknowledged then the VC can be used and the RC shall broadcast an Event Packet describing the event to all clients (including itself).


##### Event Packet(s)
All events in the game are represented across the network through Event Packets (EP) including key presses, acknowledgements, etc.
Each EP sent by a Client must include the following information.

* clientId
* Vector Clock timestamp
* event type (JOIN, QUIT, ACTION, ACK, NACK, etc)
* event details (direction, score, etc)
